//! System operations - wallpaper, power, system info

use super::{OsError, OsResult};
use std::path::Path;
use tokio::fs;
use tokio::process::Command;
use tokio::task;
use sysinfo::System;

/// Set wallpaper using swww
pub async fn wallpaper_set(image_path: &str) -> OsResult<()> {
    let output = Command::new("swww")
        .args(&["img", image_path])
        .output()
        .await?;
    
    if !output.status.success() {
        return Err(OsError::OperationFailed(
            String::from_utf8_lossy(&output.stderr).to_string()
        ));
    }
    
    Ok(())
}

/// Get battery level
pub async fn battery_level() -> OsResult<u8> {
    let power_supply = Path::new("/sys/class/power_supply");
    if !power_supply.exists() {
        return Err(OsError::OperationFailed(
            "power supply information unavailable".to_string(),
        ));
    }

    let mut entries = fs::read_dir(power_supply).await?;
    while let Some(entry) = entries.next_entry().await? {
        let name = entry.file_name().to_string_lossy().to_string();
        if !name.starts_with("BAT") {
            continue;
        }
        let capacity_file = entry.path().join("capacity");
        if capacity_file.exists() {
            let raw = fs::read_to_string(capacity_file).await?;
            let parsed = raw
                .trim()
                .parse::<u8>()
                .map_err(|e| OsError::OperationFailed(e.to_string()))?;
            return Ok(parsed);
        }
    }

    Err(OsError::OperationFailed(
        "battery capacity not found".to_string(),
    ))
}

/// Get memory info
pub async fn memory_info() -> OsResult<MemoryInfo> {
    task::spawn_blocking(|| {
        let mut system = System::new_all();
        system.refresh_all();

        Ok(MemoryInfo {
            total_mb: system.total_memory() / 1024,
            used_mb: system.used_memory() / 1024,
            available_mb: system.available_memory() / 1024,
        })
    })
    .await
    .map_err(|e| OsError::OperationFailed(e.to_string()))?
}

/// Shutdown system
pub async fn shutdown() -> OsResult<()> {
    let output = Command::new("systemctl")
        .args(&["poweroff"])
        .output()
        .await?;
    
    if !output.status.success() {
        return Err(OsError::OperationFailed(
            String::from_utf8_lossy(&output.stderr).to_string()
        ));
    }
    
    Ok(())
}

/// Reboot system
pub async fn reboot() -> OsResult<()> {
    let output = Command::new("systemctl")
        .args(&["reboot"])
        .output()
        .await?;
    
    if !output.status.success() {
        return Err(OsError::OperationFailed(
            String::from_utf8_lossy(&output.stderr).to_string()
        ));
    }
    
    Ok(())
}

#[derive(Debug, Clone, serde::Serialize)]
pub struct MemoryInfo {
    pub total_mb: u64,
    pub used_mb: u64,
    pub available_mb: u64,
}
